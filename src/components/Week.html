<script>
    import { onMount } from 'svelte';
    import { getWeek, format, addDays } from 'date-fns';
    import cloneDeep from 'lodash/cloneDeep';
    
    import { selected_event } from '../store.js';

    export let user;
    export let slug;
    export let date;
    export let dataDays;
    export let displayDays;
    export let socket;
    let onCall = [];
    let days = cloneDeep(displayDays);

    const callClick = dayIndex => () => {
            let daydate = format(addDays(date, dayIndex), "yyyyMMdd");
            let event = {slug: slug};
            
            // determine if this day for this user has a custom event (e.g oncall, vacation,...)
            let dataDayIndex = dataDays.findIndex((x) => x.date === daydate && x.user == user.id);
            // this day had a record
            if (dataDayIndex >= 0) {
                if(dataDays[dataDayIndex].type == $selected_event) {
                    dataDays[dataDayIndex].type = 0;
                }else{
                    dataDays[dataDayIndex].type = $selected_event;
                }
                event.data = dataDays[dataDayIndex];
            }else{
                event.data = {
                    slug: slug,
                    date: daydate,
                    user: user.id,
                    type: $selected_event
                }
            }
            socket.emit("day", event);
        };
        
</script>

<div class="week">
    <span class="cell week-row-header">{user.name}</span>
    {#each days as day, i}
    <span 
        on:click={callClick(i)}
        class="cell day {dataDays.find((x) => 
                  (x.date === format(addDays(date, i), 'yyyyMMdd') && x.user == user.id)) == null?'day-evt-0':'day-evt-'+dataDays.find((x) => x.date === format(addDays(date, i), 'yyyyMMdd') && x.user == user.id).type}"
        class:disabled="{day.disabled}">
    </span>
    {/each}
</div>

<style>
    /*@import "./styles_variables.less";*/
    .week-row-header {
        vertical-align: top;
        line-height: 25px;
        display: inline-block;
        width: 15%;
    }

    .disabled {
        background-color: gainsboro;
    }
</style>